import{j as e,y as He,x as me,z as xt,r as t,u as Re,i as De,n as Ge,l as ee,o as W,U as Ae,H as Me,p as he,N as Pe,D as Oe,B as we,F as ze,S as _e,q as F,X as ut,Y as te,s as qe,v as Ke,L as Ve,M as Ye}from"./vendor-CR9QeBO-.js";import{a as ht}from"./arrow-Dt4f_FJz.js";import{s as fe}from"./selected-kuvggaMB.js";import{p as mt}from"./purple-mining-machine-qJc6x0wW.js";import{t as et,u as tt,w as ft}from"./usePopup-Ddlz1WPY.js";import{s as st}from"./started-CK8rpOhi.js";import{S as q,P as Le,L as se,I as Ie,A as at,N as xe,C as gt}from"./index-BmXiOrEl.js";import{A as ae,N as ie}from"./index-CwKQTuFo.js";import{c as b}from"../assets/index-CclTo9Qo.js";import{u as it}from"./useSequentialContractWrite-cHpKk7aX.js";import{u as nt}from"./usePaymentCheck-DogNEEyR.js";import{E as Xe}from"./EmptyComp-DEO9vGp4.js";import{M as K}from"./MiningMachineSystemStorage-v65BGZKl.js";import{M as Se}from"./MiningMachineProductionLogic-NN_EtVms.js";import{M as ve}from"./MiningMachineSystemLogic-BvMT4rBv.js";import{t as pt}from"./transfer-CmFgXUEi.js";import{u as bt}from"./user-machine-DxW_ZeqC.js";import{g as vt}from"./helper-CPLEapGt.js";import{M as ue}from"./MiningMachineNodeSystem-DwTBrQlD.js";const ct="data:image/svg+xml,%3csvg%20viewBox='0%200%2013%2017.9375'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='13'%20height='17.9375'%20fill='none'%20customFrame='%23000000'%3e%3cg%20id='组合%203211'%3e%3cpath%20id='矢量%20101'%20d='M6.5001%205.09058C5.38299%205.09058%204.47412%205.96052%204.47412%207.02977C4.47412%208.09903%205.38299%208.96894%206.5001%208.96894C7.6172%208.96894%208.52608%208.099%208.52608%207.02975C8.52608%205.96049%207.6172%205.09058%206.5001%205.09058L6.5001%205.09058ZM6.5001%207.51455C6.22076%207.51455%205.9936%207.29699%205.9936%207.02975C5.9936%206.7625%206.22076%206.54495%206.5001%206.54495C6.77943%206.54495%207.00659%206.7625%207.00659%207.02975C7.00659%207.29702%206.77943%207.51455%206.5001%207.51455Z'%20fill='rgb(58,58,63)'%20fill-rule='nonzero'%20/%3e%3cpath%20id='矢量%20102'%20d='M12%2010.7196L12%208.53166C12%206.53235%2011.401%205.07393%2010.2678%203.39726C9.51378%202.2816%208.5473%201.32727%207.42859%200.568003C7.12923%200.3649%206.82071%200.173763%206.49993%200C6.17929%200.173763%205.87077%200.3649%205.57141%200.568003C4.4527%201.32727%203.48621%202.2816%202.73216%203.39726C1.59899%205.07393%201%206.53235%201%208.53166L1%2010.7196L0%2012.6465L0%2014.8776L13%2014.8776L13%2012.6465L12%2010.7196ZM11.4805%2013.4232L1.51946%2013.4232L1.51946%2013.2487L2.51946%2011.3219L2.51946%208.53166C2.51946%206.81332%203.03423%205.62809%204.00789%204.1872C4.66784%203.21086%205.51586%202.37774%206.49991%201.72049C7.48395%202.37774%208.33211%203.21086%208.99206%204.1872C9.96572%205.62809%2010.4805%206.81335%2010.4805%208.53166L10.4805%2011.3218L11.4805%2013.2487L11.4805%2013.4232L11.4805%2013.4232ZM6.50004%2016.3274C5.89968%2016.0338%205.51476%2015.6786%205.05662%2015.2711L2.89635%2015.2711C3.84849%2016.3311%204.82673%2017.1949%206.18052%2017.7957L6.50004%2017.9375L6.81956%2017.7957C8.17322%2017.195%209.15132%2016.3312%2010.1035%2015.2711L7.94346%2015.2711C7.48535%2015.6786%207.1004%2016.0338%206.50004%2016.3274Z'%20fill='rgb(58,58,63)'%20fill-rule='nonzero'%20/%3e%3c/g%3e%3c/svg%3e",wt="data:image/svg+xml,%3csvg%20viewBox='0%200%2021.5217%2021.5217'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='21.5217285'%20height='21.5217285'%20fill='none'%20customFrame='%23000000'%3e%3cg%20id='组合%203218'%3e%3cpath%20id='矢量%20103'%20d='M14.6177%206.42963C15.157%206.98797%2015.157%207.88976%2014.6177%208.4481L8.21638%2014.9944C7.95548%2015.2632%207.6014%2015.4142%207.23218%2015.4142C6.86296%2015.4142%206.50893%2015.2632%206.24798%2014.9944L0%208.5719L0.707107%200.707107L8.36969%200L11.4937%203.21482'%20stroke='rgb(58,58,63)'%20stroke-linecap='round'%20stroke-linejoin='round'%20stroke-width='1.5'%20transform='matrix(0.707107,0.707107,-0.707107,0.707107,10.8994,0)'%20/%3e%3cpath%20id='矢量%20104'%20d='M0.966038%201.98825C1.49956%201.98825%201.93208%201.54316%201.93208%200.994123C1.93208%200.445089%201.49956%200%200.966038%200C0.432515%200%200%200.445089%200%200.994123C0%201.54316%200.432515%201.98825%200.966038%201.98825Z'%20fill='rgb(58,58,63)'%20fill-rule='evenodd'%20transform='matrix(0.707107,0.707107,-0.707107,0.707107,10.8359,5.4353)'%20/%3e%3c/g%3e%3c/svg%3e",jt="/assets/bottom-pattern-DyYAFLDO.svg",Nt="data:image/svg+xml,%3csvg%20viewBox='0%200%2018%2018'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='18'%20height='18'%20fill='none'%20customFrame='%23000000'%3e%3cg%20id='组合%203398'%3e%3cpath%20id='多边形%204'%20d='M15.2354%2012.8L15.9282%2014L14.5426%2014L3.45744%2014L2.0718%2014L2.76462%2012.8L8.30718%203.2L9%202L9.69282%203.2L15.2354%2012.8ZM13.8497%2012.8L4.15026%2012.8L9%204.4L13.8497%2012.8Z'%20fill='rgb(0,0,0)'%20fill-rule='evenodd'%20/%3e%3ccircle%20id='椭圆%2040'%20cx='9'%20cy='2'%20r='2'%20fill='rgb(0,0,0)'%20/%3e%3ccircle%20id='椭圆%2041'%20cx='2'%20cy='14'%20r='2'%20fill='rgb(0,0,0)'%20/%3e%3ccircle%20id='椭圆%2042'%20cx='16'%20cy='14'%20r='2'%20fill='rgb(0,0,0)'%20/%3e%3c/g%3e%3c/svg%3e",Ct="data:image/svg+xml,%3csvg%20viewBox='0%200%2016%2016'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='16'%20height='16'%20fill='none'%20customFrame='%23000000'%3e%3cg%20id='组合%203440'%3e%3ccircle%20id='椭圆%2046'%20cx='8'%20cy='8'%20r='8'%20fill='rgb(111,75,190)'%20/%3e%3cpath%20id='矢量%20171'%20d='M8.25042%2010.6465L8.25042%206.52173L7.89328%206.52173L7.53613%206.52173'%20fill-rule='nonzero'%20stroke='rgb(255,255,255)'%20stroke-linecap='round'%20stroke-linejoin='round'%20stroke-width='1.5'%20/%3e%3cpath%20id='矢量%20170'%20d='M8%203C8.55228%203%209%203.44772%209%204C9%204.55228%208.55228%205%208%205C7.44772%205%207%204.55228%207%204C7%203.44772%207.44772%203%208%203Z'%20fill='rgb(127.5,127.5,127.5)'%20fill-rule='evenodd'%20/%3e%3cpath%20id='矢量%20170'%20d='M9%204C9%203.44772%208.55228%203%208%203C7.44772%203%207%203.44772%207%204C7%204.55228%207.44772%205%208%205C8.55228%205%209%204.55228%209%204Z'%20fill='rgb(255,255,255)'%20fill-rule='evenodd'%20/%3e%3cpath%20id='矢量%20172'%20d='M7.5%2011L8.93018%2011'%20stroke='rgb(255,255,255)'%20stroke-linecap='round'%20stroke-linejoin='round'%20stroke-width='1.5'%20/%3e%3c/g%3e%3c/svg%3e",yt={"adm-tabs":"_adm-tabs_5d5xy_1"},Je=(s,f,n)=>{if(s){const h=new Date().getTime(),o=Math.abs(h-n*1e3);return 90-Math.floor(o/(1e3*60*60*24))}return 90},kt=s=>{var d;const f=s+"",n=xt.SHA256(f).toString(),h=((d=n.match(/[a-zA-Z]/g))==null?void 0:d.slice(0,4).join(""))||"ABCD",o=n.slice(10,14);return(h+o).toUpperCase()},Lt=({item:s,onLeftClick:f,onRightClick:n})=>{const h=()=>s.isActivatedStakedLP;return e.jsxs("div",{className:He("bg-white p-2 flex justify-between mt-2 text-[.68rem] rounded-[24px]"),children:[e.jsxs("div",{className:"flex relative",onClick:()=>f(s),children:[!h()&&e.jsx(me,{checked:s.checked,icon:o=>o?e.jsx("img",{src:fe,alt:"",width:16,height:16}):e.jsx("div",{className:"border border-[#a5a4a4] w-[1rem] h-[1rem] rounded-[50%]"})}),e.jsx("img",{src:mt,alt:"",className:"mx-2 w-[3.625rem]"})]}),e.jsxs("div",{className:"basis-5/7 h-[58px] flex flex-col mt-1 gap-1",onClick:()=>n(s),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex rounded-3xl pr-3",style:{background:"linear-gradient(90deg, rgba(148, 61, 249, 0) 0%, rgba(148, 61, 249, 1) 100%)"},children:["#",kt(s.id),e.jsx("div",{className:"text-white ml-3",children:"母矿机"})]}),e.jsx("div",{className:"text-[#15b268] flex gap-1",children:e.jsx("img",{src:h()?st:et,alt:"",width:50})})]}),h()?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-1",children:["累计产出矿机：",e.jsxs("div",{className:"font-bold flex gap-1",children:[e.jsx("div",{children:s.producedChildCount}),"个"]})]}),e.jsxs("div",{className:"flex gap-1",children:["矿机生命剩余：",e.jsx("div",{children:Je(s.isActivatedStakedLP,s.lastProduceTime,s.activatedAt)}),"天"]})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex mt-2",children:["生命剩余：",e.jsx("div",{children:Je(s.isActivatedStakedLP,s.lastProduceTime,s.activatedAt)}),"天"]})})]})]},s.id)},St=()=>{const[s,f]=t.useState([]),{address:n}=Re(),h=De(),{writeContractAsync:o}=Ge(),[d,g]=t.useState(!1),[j,S]=t.useState(0),V=t.useRef(null),[ne,x]=t.useState(!1),[m,y]=t.useState([]),[B,U]=t.useState(""),[Y,ce]=t.useState(""),p=t.useMemo(()=>s.filter(l=>!l.isActivatedStakedLP).length||0,[s]);t.useEffect(()=>{p===m.length&&p>0?g(!0):g(!1)},[p,m]);const{executeSequentialCalls:A}=it(),R=t.useCallback(async()=>{x(!0);try{const L=(await ee(b,{address:q,abi:K,functionName:"getOwnerToMachineIds",args:[n]})).map(r=>Number(r)),C=L.map(r=>({address:q,abi:K,functionName:"getMachineLifecycle",args:[r]})),pe=(await W(b,{contracts:C})).map((r,Z)=>({activatedAt:Number(r.result.activatedAt),createTime:Number(r.result.createTime),expiredAt:Number(r.result.expiredAt),destroyed:r.result.destroyed,isActivatedStakedLP:r.result.isActivatedStakedLP,isFuelPaid:r.result.isFuelPaid,isProducing:r.result.isProducing,checked:!1,id:L[Z],lastProduceTime:Number(r.result.lastProduceTime),producedChildCount:Number(r.result.producedChildCount),producedHours:Number(r.result.producedHours),mtype:r.result.mtype,fuelRemainingMinutes:Number(r.result.fuelRemainingMinutes)})).filter(r=>r.mtype===1),be=pe.map(r=>({address:q,abi:K,functionName:"_isOnSale",args:[r.id]})),Ee=await W(b,{contracts:be}),Ne=pe.map((r,Z)=>({...r,isOnSale:Ee[Z].result})),Fe=Ne.map(r=>({address:Le,abi:Se,functionName:"viewMachineProduction",args:[r.id]})),Be=await W(b,{contracts:Fe}),Ce=Ne.map((r,Z)=>({...r,unclaimedChildCount:Number(Be[Z].result[2])}));f(Ce.sort((r,Z)=>r.activatedAt-Z.activatedAt).filter(r=>!r.destroyed)),console.log("mother machine list",Ce)}catch(l){console.log(l)}finally{x(!1)}},[n]);t.useEffect(()=>{R()},[R]),t.useEffect(()=>{d&&y(s.filter(l=>!l.isActivatedStakedLP&&!l.isOnSale))},[d,s]);const le=()=>{f(l=>{const L=l.map(C=>C.isActivatedStakedLP?C:{...C,checked:!d});return y(d?[]:L.filter(C=>!C.isActivatedStakedLP)),L}),g(!d)},J=l=>l?e.jsx("img",{src:fe,alt:"",width:16,height:16}):e.jsx("div",{className:"border border-[#a5a4a4] w-[1rem] h-[1rem] rounded-[50%]"});t.useEffect(()=>{if(!V.current)return;const l=()=>{const E=window.innerHeight-230;S(E)};return l(),window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[]);const ge=t.useCallback(l=>{f(L=>{const C=L.map(M=>M.isActivatedStakedLP?M:M.id===l.id?{...M,checked:!M.checked}:M);if(!C.find(M=>M.id===l.id).isActivatedStakedLP)if(!l.checked)y(d?s:[...m,l]);else{const pe=m.filter(be=>be.id!==l.id);y(pe),g(!1)}return C})},[d,s,m]),re=l=>{h("/user/machineDetail",{state:l})},G=t.memo(({index:l,style:L,data:C})=>{const E=C[l];return e.jsx("div",{style:{...L,height:"70px"},children:e.jsx(Lt,{item:E,onLeftClick:ge,onRightClick:re})})}),{data:de,isLoading:D,error:je}=Ae({address:se,abi:ve,functionName:"getIDXAmount",args:[15]}),{data:O,isLoading:z,error:_}=Ae({address:Ie,abi:Me,functionName:"balanceOf",args:[n]});t.useEffect(()=>{z||ce(he(O))},[z,O]),t.useEffect(()=>{D||U(he(de))},[D,de]);const[i,N]=t.useState(!1),P=async()=>{if(m.length===0){F.show({content:"请选择要激活的矿机",position:"center",duration:2e3});return}$(!0)},{isLoading:X,isAllowanceSufficient:I}=nt(Pe(String(Math.ceil(+B*m.length)))),Q=async()=>{try{if(X)return;N(!0),I||await o({address:Ie,abi:Me,functionName:"approve",args:[se,Pe(at)]});const l=m.map(E=>({address:se,abi:ve,functionName:"activateMachineWithLP",args:[E.id]}));(await A(l)).some(E=>E.success)&&(F.show({content:"激活成功!",position:"center"}),R()),y([]),g(!1)}catch(l){console.error(l)}finally{$(!1),N(!1)}},{setOpen:$,component:k}=tt({title:"",contentClassName:"",closeButtonClassName:"",content:e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"text-[#6433EC] font-bold text-[15px] pt-2 pb-4",children:"激活矿机需支付打底池费用!"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{className:"font-bold text-[14px]",children:"待支付IDX"}),e.jsx("div",{className:"text-[#FF5050] font-bold text-[16px]",children:e.jsx(ae,{type:ie.BALANCE,value:+B*m.length,decimalSubLen:2,className:"ml-2 mr-1.5"})})]}),e.jsxs("div",{className:"flex justify-end text-[12px]",children:[e.jsx("div",{className:"text-[#686D6D]",children:"钱包余额："}),e.jsx("div",{className:"font-bold",children:e.jsx(ae,{type:ie.BALANCE,value:Y,decimalSubLen:2,className:"ml-2 mr-1.5"})})]})]}),e.jsx(Oe,{}),e.jsx(we,{onClick:Q,className:"!bg-black !rounded-3xl !text-white flex justify-center !py-2 w-full !text-[16px]",loading:i,disabled:+Y<+B*m.length,children:+Y>+B*m.length?"支付费用":"余额不足"})]})});return e.jsxs("div",{className:"pt-4 flex flex-col justify-between h-full",children:[k,e.jsxs("div",{className:"px-[21px]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(me,{className:"mr-6 h-[32px] ",checked:d,icon:l=>J(l),onClick:le,style:{"--font-size":"14px","--gap":"6px"},children:"全选"}),e.jsxs("div",{className:"flex text-[#505050] text-[14px]",children:["待激活矿机，共计:",e.jsx("div",{className:"text-black font-bold mx-1",children:p}),"台"]})]}),e.jsx("div",{ref:V,style:{height:`${j}px`},className:"no-scrollbar",children:ne?e.jsx(_e.Paragraph,{lineCount:6,animated:!0,className:"customSkeleton"}):s.length>0?e.jsx(ze,{height:j,width:"100%",itemCount:s.length,itemSize:85,itemData:s,children:G}):e.jsx(Xe,{})})]}),e.jsx("div",{className:"w-full bg-white h-[4rem] flex justify-around items-center px-[30px] text-[12px]",onClick:P,children:e.jsxs("div",{className:" flex flex-col justify-center items-center",children:[e.jsx("img",{src:ct,alt:"",width:15}),e.jsx("div",{children:"激活"})]})})]})},At=({item:s,onLeftClick:f,onRightClick:n})=>{const h=()=>s.isOnSale||s.isActivatedStakedLP,o=g=>Math.floor(360*(1440-d())/1440),d=()=>s.producedMix!==void 0&&s.producedMix>0?+he(BigInt(s.producedMix)):0;return e.jsxs("div",{className:"bg-white rounded-2xl p-2  flex justify-between mt-2 text-[.68rem]",children:[e.jsxs("div",{className:"flex relative",onClick:()=>f(s),children:[!h()&&e.jsx(me,{checked:s.checked,icon:g=>g?e.jsx("img",{src:fe,alt:"",width:16,height:16}):e.jsx("div",{className:"border border-[#a5a4a4] w-[1rem] h-[1rem] rounded-[50%]"})}),e.jsx("img",{src:bt,alt:"",width:58,className:"mx-2"})]}),e.jsxs("div",{className:"basis-5/7 h-[58px] flex flex-col gap-1.5 justify-center",onClick:()=>n(s),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex rounded-3xl pr-3",style:{background:"linear-gradient(90deg, rgba(165, 115, 71, 0) 0%, rgba(187, 112, 84, 1) 100%)"},children:["#",vt(s.id),e.jsx("div",{className:"text-white ml-3",children:"矿机"})]}),e.jsx("div",{className:"text-[#15b268] flex gap-1",children:e.jsx("img",{src:h()?st:et,alt:"",width:50})})]}),e.jsxs("div",{className:"flex gap-1",children:["累计产出通证：",e.jsxs("div",{className:"font-bold text-[12px] flex gap-1",children:[e.jsx(ae,{type:ie.BALANCE,value:d(),decimalSubLen:2,className:"font-bold"}),e.jsx("span",{children:"MIX"})]})]}),e.jsxs("div",{className:"flex gap-1",children:["矿机生命剩余：",e.jsxs("div",{className:"font-bold text-[12px]",children:[o(s.producedMix),"天"]})]})]})]},s.id)},Mt=({isShow:s})=>{const{address:f}=Re(),[n,h]=t.useState([]),[o,d]=t.useState(!1),[g,j]=t.useState(0),S=t.useRef(null),[V,ne]=t.useState(!1),[x,m]=t.useState([]),[y,B]=t.useState(""),[U,Y]=t.useState(""),{writeContractAsync:ce}=Ge(),{executeSequentialCalls:p}=it(),[A,R]=t.useState(0),[le,J]=t.useState([]),[ge,re]=t.useState(!1),G=De(),[de,D]=t.useState(!1),[je,O]=t.useState(0),z=t.useMemo(()=>n.filter(c=>!c.isActivatedStakedLP).length||0,[n]);t.useEffect(()=>{z===x.length&&z>0?d(!0):d(!1)},[z,x]);const _=t.useCallback(async()=>{try{ne(!0);const v=(await ee(b,{address:q,abi:K,functionName:"getOwnerToMachineIds",args:[f]})).map(a=>Number(a)),w=v.map(a=>({address:q,abi:K,functionName:"getMachineLifecycle",args:[a]})),u=(await W(b,{contracts:w})).map((a,H)=>({activatedAt:Number(a.result.activatedAt),createTime:Number(a.result.createTime),expiredAt:Number(a.result.expiredAt),destroyed:a.result.destroyed,isActivatedStakedLP:a.result.isActivatedStakedLP,isFuelPaid:a.result.isFuelPaid,isProducing:a.result.isProducing,checked:!1,id:v[H],lastProduceTime:Number(a.result.lastProduceTime),producedChildCount:Number(a.result.producedChildCount),producedHours:Number(a.result.producedHours),mtype:a.result.mtype,fuelRemainingMinutes:Number(a.result.fuelRemainingMinutes)})),oe=u.filter(a=>a.mtype===1&&a.isActivatedStakedLP).map(a=>a.id),ye=oe.map(a=>({address:Le,abi:Se,functionName:"viewMachineProduction",args:[a]})),ke=await W(b,{contracts:ye}),$e=ke.reduce((a,H)=>(a=Number(H.result[2])>0?a+1:a,a),0);console.log(`curren has ${$e} child to claim`,ke),R($e),J(oe);const Ze=u.filter(a=>a.mtype===2),rt=Ze.map(a=>({address:Le,abi:Se,functionName:"viewMachineProduction",args:[a.id]})),Ue=await W(b,{contracts:rt}),Qe=Ze.map((a,H)=>Ue[H].status==="success"?{...a,producedMix:Number(Ue[H].result[3])}:{...a,producedMix:0}),dt=Qe.map(a=>({address:q,abi:K,functionName:"_isOnSale",args:[a.id]})),ot=await W(b,{contracts:dt}),We=Qe.map((a,H)=>({...a,isOnSale:ot[H].result})).filter(a=>!a.isOnSale&&!a.isActivatedStakedLP).sort((a,H)=>a.activatedAt-H.activatedAt);console.log("child machine list",We),h(We)}catch(c){console.error(c)}finally{ne(!1)}},[f]),i=t.useCallback(async()=>{try{re(!0);const c=le.map(v=>({address:Le,abi:Se,functionName:"claimChildren",args:[v],onConfirmed:(w,T)=>{R(u=>u===0?u:u-1),console.log(`Approval confirmed for call ${T+1}`)}}));await p(c),_(),re(!1)}catch(c){console.error(c)}},[p,le,_]);t.useEffect(()=>{s&&_(),s||m([])},[_,s]),t.useEffect(()=>{o&&m(n.filter(c=>!c.isActivatedStakedLP)),n.length===x.length&&x.length>0&&d(!0)},[o,n,x.length]);const N=()=>{h(c=>{const v=c.map(w=>w.isActivatedStakedLP?w:{...w,checked:!o});return m(o?[]:v.filter(w=>!w.isActivatedStakedLP)),v}),d(!o)},P=c=>c?e.jsx("img",{src:fe,alt:"",width:16,height:16}):e.jsx("div",{className:"border border-[#a5a4a4] w-[1rem] h-[1rem] rounded-[50%]"});t.useEffect(()=>{if(!S.current)return;const c=()=>{const v=window.innerHeight,w=A>0?201:170,T=v-w;j(T)};return c(),window.addEventListener("resize",c),()=>window.removeEventListener("resize",c)},[A]);const X=t.useCallback(c=>{h(v=>{const w=v.map(u=>u.isActivatedStakedLP?u:u.id===c.id?{...u,checked:!u.checked}:u);if(!c.checked)m(o?n:[...x,c]);else{const u=x.filter(oe=>oe.id!==c.id);m(u),d(!1)}return w})},[o,n,x]),I=c=>{G("/user/machineDetail",{state:c})},Q=t.memo(({index:c,style:v,data:w})=>{const T=w[c];return e.jsx("div",{style:{...v,height:"70px"},children:e.jsx(At,{item:T,onLeftClick:X,onRightClick:I})})}),[$,k]=t.useState(!1),{data:l,isLoading:L,error:C}=Ae({address:se,abi:ve,functionName:"getIDXAmount",args:[15]}),{data:E,isLoading:M,error:pe}=Ae({address:Ie,abi:Me,functionName:"balanceOf",args:[f]});t.useEffect(()=>{M||Y(he(E))},[M,E]),t.useEffect(()=>{L||B(he(l))},[L,l]);const be=async()=>{if(x.length===0){F.show({content:"请选择要一个激活的矿机",position:"center",duration:2e3});return}Te(!0)},{isLoading:Ee,isAllowanceSufficient:Ne}=nt(Pe(String(Math.ceil(+y*x.length)))),Fe=async()=>{try{if(Ee)return;O(x.length),D(!0),k(!0),Ne||await ce({address:Ie,abi:Me,functionName:"approve",args:[se,Pe(at)]});const c=x.map(u=>({address:se,abi:ve,functionName:"activateMachineWithLP",args:[u.id],onConfirmed:(oe,ye)=>{O(ke=>ke-1)}})),v=await p(c),w=v.every(u=>!u.success),T=v.find(u=>u.success);w&&F.show({content:"取消激活",position:"center"}),T&&(F.show({content:"激活成功",position:"center"}),_(),m([])),d(!1),k(!1),D(!0),O(0),Te(!1)}catch(c){F.show({content:"激活失败，请稍后再试",position:"center"}),d(!1),k(!1),D(!0),O(0),Te(!1),console.error(c)}},Be=()=>{te.clear()},Ce=()=>{G("/user"),te.clear()},r=()=>{if(x.length===0){F.show({content:"请选择要转让的矿机",position:"center"});return}G("/user/transferMachine",{state:x})},Z=async()=>{if(x.length===0){F.show({content:"请选择要挂售的矿机",position:"center"});return}console.log("selling out machine list",x);try{let c=0;const v=x.map(u=>({address:se,abi:ve,functionName:"listChildMachine",args:[u.id],onConfirmed:(oe,ye)=>{c++,console.log(`Approval confirmed for call ${ye+1}`)}}));(await p(v)).find(u=>u.success)&&(_(),te.show({bodyStyle:{background:"#000000",color:"#ffffff",width:"75vw",padding:"15px",borderRadius:"20px"},showCloseButton:!0,closeOnMaskClick:!0,content:e.jsxs("div",{className:"pt-[15px] text-white text-[15px] flex flex-col gap-4",children:[e.jsx("div",{className:"text-[#B195FF]",children:"提示"}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:["您已向交易市场上架了“",c,"台矿机” ，请耐心等待买家购买。"]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"w-full bg-black rounded-3xl text-white py-2 border border-[#666]",onClick:Be,children:"知道了"}),e.jsx("button",{className:"w-full bg-[#895EFF] rounded-3xl text-white py-2",onClick:Ce,children:"去看看"})]})]})]})}))}catch(c){F.show({content:"挂售失败，请稍后再试",position:"center"}),console.error(c)}},{setOpen:Te,component:lt}=tt({title:"",contentClassName:"",closeButtonClassName:"",content:e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"text-[#6433EC] font-bold text-[15px] pt-2 pb-4",children:"激活矿机需支付打底池费用!"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{className:"font-bold text-[14px]",children:"待支付IDX"}),e.jsx("div",{className:"text-[#FF5050] font-bold text-[16px]",children:e.jsx(ae,{type:ie.BALANCE,value:+y*x.length,decimalSubLen:2,className:"ml-2 mr-1.5"})})]}),e.jsxs("div",{className:"flex justify-end text-[12px]",children:[e.jsx("div",{className:"text-[#686D6D]",children:"钱包余额："}),e.jsx("div",{className:"font-bold",children:e.jsx(ae,{type:ie.BALANCE,value:U,decimalSubLen:2,className:"ml-2 mr-1.5"})})]})]}),e.jsx(Oe,{}),e.jsx(we,{onClick:Fe,className:"!bg-black !rounded-3xl !text-white flex justify-center !py-2 w-full !text-[16px]",loading:$,disabled:+U<+y*x.length,children:+U>+y*x.length?"支付费用":"余额不足"})]})});return e.jsxs("div",{className:"pt-2 flex flex-col justify-between h-full",children:[lt,e.jsx(ut,{visible:de,onMaskClick:()=>D(!1),children:e.jsxs("div",{className:"bg-[#1d1c25] rounded-xl text-white",children:["你有",e.jsx("span",{className:"text-[#895eff] text-[1rem] font-bold",children:je}),"笔交易待处理"]})}),e.jsxs("div",{className:"px-[21px]",children:[A>0&&e.jsx("div",{className:"w-full flex justify-center",children:e.jsx(we,{className:"!bg-black !rounded-3xl !text-white flex justify-center !py-1  ",onClick:i,disabled:ge,children:e.jsxs("div",{className:"text-[13px]",children:["待领取子矿机：",e.jsx("span",{className:"text-[red]  text-[14px] font-bold mx-1",children:A}),"个，点击领取所有子矿机"]})})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(me,{className:"mr-6 h-[32px] ",checked:o,icon:c=>P(c),onClick:N,style:{"--font-size":"14px","--gap":"6px"},children:"全选"}),e.jsxs("div",{className:"flex text-[#505050] text-[.875rem]",children:["待激活矿机，共计:",e.jsx("div",{className:"text-black font-bold mx-1",children:z}),"台"]})]}),e.jsx("div",{ref:S,style:{height:`${g}px`},className:"no-scrollbar",children:V?e.jsx(_e.Paragraph,{animated:!0,className:"customSkeleton"}):n.length>0?e.jsx(ze,{height:g,width:"100%",itemCount:n.length,itemSize:80,itemData:n,children:Q}):e.jsx(Xe,{})})]}),e.jsxs("div",{className:"w-full bg-white h-[64px] flex justify-around items-center px-[30px] text-[12px]",children:[e.jsxs("div",{className:" flex flex-col justify-center items-center",onClick:be,children:[e.jsx("img",{src:ct,alt:"",width:15}),e.jsx("div",{children:"激活矿机"})]}),e.jsxs("div",{className:"flex flex-col justify-center items-center ",onClick:r,children:[e.jsx("img",{src:pt,alt:"",width:18}),e.jsx("div",{children:"转让"})]}),e.jsxs("div",{className:"flex flex-col justify-center items-center ",onClick:Z,children:[e.jsx("img",{src:wt,alt:"",width:20}),"挂售"]})]})]})},Pt=({item:s,onLeftClick:f})=>e.jsxs("div",{className:He("p-2 bg-white flex justify-between mt-2 text-[.68rem] rounded-[24px]"),children:[e.jsxs("div",{className:"flex relative",onClick:()=>f(s),children:[e.jsx(me,{checked:s.checked,icon:n=>n?e.jsx("img",{src:fe,alt:"",width:16,height:16}):e.jsx("div",{className:"border border-[#a5a4a4] w-[1rem] h-[1rem] rounded-[50%]"})}),e.jsx("div",{className:"bg-black w-[58px] h-[58px] mx-2 rounded-2xl"})]}),e.jsxs("div",{className:"basis-5/7  flex flex-col justify-center gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{className:"flex justify-center rounded-3xl  w-[80px]",children:e.jsx("div",{className:"w-full pr-2",children:"矿机"})}),e.jsx("div",{className:"text-[#15b268] flex gap-1",children:e.jsx("img",{src:ft,alt:"",width:65})})]}),e.jsx("div",{className:"flex",children:"生命剩余： 0 天"})]})]},s.id),It=()=>{const[s,f]=t.useState([]),[n,h]=t.useState(!1),[o,d]=t.useState(0),{address:g}=Re(),[j,S]=t.useState(0),[V,ne]=t.useState(0),[x,m]=t.useState(!1),[y,B]=t.useState(!1),[U,Y]=t.useState(0),ce=t.useRef(null),[p,A]=t.useState([]);t.useEffect(()=>{n&&A(s)},[n,s]),t.useEffect(()=>{s.length===p.length&&p.length>0&&h(!0)},[s,p]);const R=()=>{te.clear()},le=async()=>{try{B(!0);const i=await qe(b,{address:xe,abi:ue,functionName:"claimMixReward",args:[]});await Ke(b,{hash:i,chainId:gt}),te.show({bodyStyle:{background:"#000000",color:"#ffffff",width:"75vw",padding:"15px",borderRadius:"20px"},showCloseButton:!0,closeOnMaskClick:!0,content:e.jsxs("div",{className:"pt-[15px] text-white text-[15px] flex flex-col gap-4",children:[e.jsx("div",{className:"text-[#B195FF]",children:"提示"}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:["你已成功提取MIX收益：",e.jsx(ae,{type:ie.BALANCE,value:o,decimalSubLen:2,className:"font-bold text-[15px]"}),"，已存入你的钱包中。"]}),e.jsx("button",{className:"w-full bg-[#895EFF] rounded-3xl text-white py-2",onClick:R,children:"确认"})]})]})}),J()}catch(i){F.show({content:"提取失败，请稍后再试",position:"center"}),console.error(i)}finally{B(!1)}},J=t.useCallback(async()=>{try{m(!0);const N=(await ee(b,{address:q,abi:K,functionName:"getOwnerToMachineIds",args:[g]})).map(k=>Number(k)),P=N.map(k=>({address:q,abi:K,functionName:"getMachineLifecycle",args:[k]})),I=(await W(b,{contracts:P})).map((k,l)=>({destroyed:k.result.destroyed,mtype:k.result.mtype,checked:!1,id:N[l]})),Q=await ee(b,{address:xe,abi:ue,functionName:"destroyedMachineCount",args:[g]});let $=I.filter(k=>k.destroyed);$=$.slice(0,Number(Q)),f($),console.log("filter nodesAmount * list",$,Number(Q))}catch(i){console.log(i)}finally{m(!1)}},[g]);t.useEffect(()=>{J()},[J]);const ge=async()=>{try{const i=await ee(b,{address:xe,abi:ue,functionName:"nodesAmount",args:[]});ne(Number(i))}catch(i){console.error(i)}};t.useEffect(()=>{ge()},[]);const re=async()=>{try{const i=await ee(b,{address:xe,abi:ue,functionName:"getUserNodeCount",args:[g]});S(Number(i))}catch(i){console.error(i)}};t.useEffect(()=>{re(),G()},[]);const G=async()=>{try{const i=await ee(b,{address:xe,abi:ue,functionName:"getUserCurrentAvailableMix",args:[g]});d(+he(i))}catch(i){console.error(i)}};t.useEffect(()=>{if(!ce.current)return;const i=()=>{const X=window.innerHeight-100;Y(X)};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]);const de=t.useCallback(i=>{f(N=>{const P=N.map(I=>I.id===i.id?{...I,checked:!I.checked}:I);if(!i.checked)A(n?s:[...p,i]);else{const I=p.filter(Q=>Q.id!==i.id);A(I),h(!1)}return P})},[n,s,p]),D=i=>i?e.jsx("img",{src:fe,alt:"",width:16,height:16}):e.jsx("div",{className:"border border-[#a5a4a4] w-[1rem] h-[1rem] rounded-[50%]"}),je=()=>{f(i=>{const N=i.map(P=>({...P,checked:!n}));return A(n?[]:N),N}),h(!n)},O=t.memo(({index:i,style:N,data:P})=>{const X=P[i];return e.jsx("div",{style:{...N,height:"70px"},children:e.jsx(Pt,{item:X,onLeftClick:de})})}),z=async()=>{if(p.length<V){F.show({content:`所选残骸数量不足${V}个，无法执行操作`,position:"bottom",duration:2e3});return}try{B(!0);const i=await qe(b,{address:xe,abi:ue,functionName:"createNode",args:[]});await Ke(b,{hash:i}),te.show({bodyStyle:{background:"#000000",color:"#ffffff",width:"75vw",padding:"15px",borderRadius:"20px"},showCloseButton:!0,closeOnMaskClick:!0,content:e.jsxs("div",{className:"pt-[15px] text-white text-[15px] flex flex-col gap-4",children:[e.jsx("div",{className:"text-[#B195FF]",children:"提示"}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:"恭喜你“合成小节点”执行成功，您将获得该节点5%平均分红权，以后每天享受分红！"}),e.jsx("button",{className:"w-full bg-[#895EFF] rounded-3xl text-white py-2",onClick:R,children:"确认"})]})]})})}catch(i){console.error(i),F.show({content:"合成失败，请稍后再试",position:"center"})}finally{B(!1)}},_=()=>{te.show({bodyStyle:{color:"#ffffff",width:"80vw",padding:"10px",borderRadius:"20px",height:"220px"},content:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-bold text-[15px] mt-1",children:"节点权益说明"}),e.jsx(Oe,{}),e.jsx("div",{className:"font-bold text-[15px] mb-4",children:"合成NFT小节点"}),e.jsxs("div",{className:"flex mb-4 gap-1 w-full",children:[e.jsx("div",{className:"bg-[#8665E0] rounded-[5px] px-1 text-white w-[40px] h-[20px] text-[12px] text-center",children:"条件"}),e.jsxs("div",{className:"text-[12px]",children:["需",e.jsx("span",{className:"text-[#8665E0] font-bold text-[14px]",children:"100"}),"台矿机残骸合成1个小节点"]})]}),e.jsxs("div",{className:"flex gap-1 w-full",children:[e.jsx("div",{className:"bg-[#8665E0] rounded-[5px] px-1 text-white w-[40px] h-[20px] text-[12px] text-center",children:"权益"}),e.jsxs("div",{className:"text-[12px] flex-1",children:["享受全网燃料费总和",e.jsx("span",{className:"text-[#8665E0] font-bold text-[14px]",children:"x5%"}),"的平均分红权。每天分红，每天领取，即刻到账。"]})]})]}),closeOnMaskClick:!0,showCloseButton:!0})};return new Array(10).fill({checked:!1,id:111,mtype:1}),e.jsxs("div",{className:"pt-4  flex flex-col justify-between h-full",children:[e.jsxs("div",{className:"px-[21px] ",children:[e.jsxs("div",{style:{background:`#000 url(${jt}) no-repeat center`,width:"100%",padding:"21px",gap:"5px",borderRadius:"25px"},children:[e.jsxs("div",{className:"text-white flex justify-between",children:["昨日节点分红",e.jsxs("div",{className:"bg-[#59368C] text-[10px] rounded-2xl text-white flex justify-center items-center px-2 gap-1",children:["小节点 x ",e.jsx("div",{children:j})]})]}),e.jsxs("div",{className:"flex   text-white items-center pt-4 justify-center",children:[e.jsx(ae,{type:ie.BALANCE,value:o,decimalSubLen:2,className:"ml-2 mr-1.5  font-bold text-[22px]"}),e.jsx("div",{className:"text-[11px] pt-[8px] ",children:"MIX"})]}),e.jsx("div",{className:"w-full flex justify-center",children:e.jsx(we,{disabled:o===0,loading:y,onClick:le,className:"w-[70%]  !bg-[#7334FE] !rounded-2xl !h-[36px] !mb-2  !items-center  !p-0 !text-white !border-none !text-[14px]",children:"提取分红"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"text-[#625A77] text-[11px] w-[80%] text-center",children:"分红每日00:00:00结算，请在次日24小时内领取，次日未领取，前日分红自动清零。"})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsx(me,{className:"mr-6 h-[32px] ",checked:n,icon:i=>D(i),onClick:je,style:{"--font-size":"14px","--gap":"6px"},children:"全选"}),e.jsxs("div",{className:"flex text-[#505050] gap-2 text-[14px]",onClick:_,children:["节点权益说明",e.jsx("img",{src:Ct,alt:""})]})]}),e.jsx("div",{ref:ce,style:{height:`${U}px`},className:"no-scrollbar  rounded-2xl  mb-[4.5rem]",children:x?e.jsx(_e.Paragraph,{animated:!0,className:"customSkeleton"}):s.length>0?e.jsx(ze,{height:U,width:"100%",itemCount:s.length,itemSize:80,itemData:s,children:O}):e.jsx(Xe,{})})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 w-full bg-white py-[.4rem] flex items-center px-[21px]",children:[p.length>0&&e.jsx("div",{className:"bg-[#F1F1F3] rounded-[50%] w-[32px] h-[32px] flex justify-center items-center text-[#895FFE] font-bold",children:p.length}),e.jsx(we,{disabled:s.length===0,onClick:z,className:"!mx-auto !border-none",children:e.jsxs("div",{className:"!flex !flex-col !items-center !justify-center",children:[e.jsx("img",{src:Nt,alt:"",width:18}),e.jsx("div",{className:"text-[13px] mt-1",children:"合成小节点"})]})})]})]})},Jt=()=>{const s=De(),f=()=>{s("/user")},n=t.useRef(null),[h,o]=t.useState("0"),d=0,g=[{title:"母矿机",children:e.jsx(St,{})},{title:"矿机",children:e.jsx(Mt,{isShow:h==="1"})},{title:"节点",children:e.jsx(It,{})}];return e.jsx("div",{className:"h-full overflow-hidden text-[16px] relative",children:e.jsxs("div",{className:"flex pt-4 w-full h-full justify-between",children:[e.jsx("div",{className:"h-[50px] flex items-center absolute top-[10px] left-[20px] ",onClick:f,children:e.jsx("img",{src:ht,alt:""})}),e.jsxs("div",{className:"w-full h-full flex flex-col justify-between",children:[e.jsx(Ve,{activeKey:h,onChange:j=>{var S;o(`${j}`),(S=n==null?void 0:n.current)==null||S.swipeTo(Number(j))},className:He([yt["adm-tabs"]],`w-[70%]  mx-auto flex justify-around
              !shrink-0  [&_.adm-tabs-tab-wrapper]:flex-none [&_.adm-tabs-tab-wrapper]:px-0
              [&_.adm-tabs-tab.adm-tabs-tab-active]:font-medium [&_.adm-tabs-tab.adm-tabs-tab-active]:opacity-100
              [&_.adm-tabs-tab]:pb-[11px] [&_.adm-tabs-tab]:pt-[14px] [&_.adm-tabs-tab]:text-[15px]
              [&_.adm-tabs-tab]:opacity-40 [&_.adm-tabs-tab]:transition-transform
          `),style:{"--title-font-size":"16px"},children:g.map((j,S)=>e.jsx(Ve.Tab,{title:j.title,className:""},S))}),e.jsx(Ye,{className:"flex-1 outline-0 ",ref:n,indicator:()=>null,tabIndex:Number(h),defaultIndex:d,onIndexChange:j=>o(`${j}`),children:g.map((j,S)=>e.jsx(Ye.Item,{className:"no-scrollbar max-w-full overflow-x-hidden overflow-y-auto",children:j.children},S))})]})]})})};export{Jt as default};
