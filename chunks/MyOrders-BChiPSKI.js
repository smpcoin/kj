import{K as Q,r as a,u as K,i as $,n as G,U as J,p as y,o as V,N as w,j as e,B as L,F as Y,l as Z,H as A,q as ee}from"./vendor-CR9QeBO-.js";import{a as se}from"./arrow-Dt4f_FJz.js";import{u as te}from"./user-machine-DxW_ZeqC.js";import{A as C,N as H}from"./index-CwKQTuFo.js";import{S as ae,L as x,I as E,A as re}from"./index-CS9n0aoQ.js";import{u as ie}from"./useSequentialContractWrite-CCpqKr9w.js";import{g as ne}from"./helper-CPLEapGt.js";import{c as I}from"../assets/index-UMXjEvK5.js";import{u as oe}from"./usePaymentCheck-Db2ne4VA.js";import{M as ce}from"./MiningMachineSystemStorage-v65BGZKl.js";import{M as D}from"./MiningMachineSystemLogic-BvMT4rBv.js";const ye=()=>{const c=Q().state,[n,M]=a.useState([]),{address:B}=K(),{executeSequentialCalls:R}=ie(),[m,d]=a.useState(!1),h=$(),[f,T]=a.useState(0),p=a.useRef(null),[g,k]=a.useState(0),[P,F]=a.useState(0),{writeContractAsync:O}=G(),U=async()=>{try{const s=await Z(I,{address:x,abi:D,functionName:"getIDXAmount",args:[1]}),r=y(s);F(+r)}catch(s){console.error(s)}};a.useEffect(()=>{U()},[]);const{data:N,isLoading:b,error:le}=J({address:E,abi:A,functionName:"balanceOf",args:[B]});a.useEffect(()=>{b||k(Number(y(N)))},[b,N]);const j=a.useCallback(async()=>{const s=c.map(t=>({address:ae,abi:ce,functionName:"getMachineLifecycle",args:[t.machineId]})),r=await V(I,{contracts:s}),i=c.map((t,l)=>({...t,producedHours:Number(r[l].result.producedHours)}));M(i)},[c]);a.useEffect(()=>{j()},[j]);const v=s=>{let i=150*(1-s/360)*P;return i<0&&(i=0),i},o=n.reduce((s,r)=>s+v(r.producedHours),0),z=()=>{h("/user")};a.useEffect(()=>{if(!p.current)return;const s=()=>{const t=window.innerHeight-100;T(t)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]);const{isLoading:W,isAllowanceSufficient:X}=oe(w(String(o))),q=async()=>{if(!W)try{if(n.length===0)return;d(!0),X||await O({address:E,abi:A,functionName:"approve",args:[x,w(re)]});const s=n.map(t=>({address:x,abi:D,functionName:"buyListedChildMachine",args:[t.orderId]}));(await R(s)).find(t=>t.success)&&(ee.show({content:"支付成功",position:"center"}),h("/user")),d(!1)}catch(s){console.error(s)}finally{d(!1)}},_=({index:s,style:r,data:i})=>{const t=i[s],l=u=>150*(1-u/360)-30===120?"新矿机":"二手矿机",S=u=>((360-u)/360).toFixed(1);return e.jsx("div",{style:{...r,height:"70px"},children:e.jsxs("div",{className:"px-3 py-2 bg-white rounded-3xl flex gap-3",children:[e.jsx("img",{src:te,alt:""}),e.jsxs("div",{className:"flex-1 h-[58px] flex flex-col gap-1 justify-center",children:[e.jsxs("div",{style:{background:"linear-gradient(90deg, rgba(165, 115, 71, 0) 0%, rgba(187, 112, 84, 1) 100%)"},className:"w-[100px] flex rounded-3xl  text-[10px]",children:["#",ne(15),e.jsx("div",{className:"text-white ml-3",children:"矿机"})]}),e.jsxs("div",{className:"flex text-[12px]",children:["类型：",e.jsx("div",{children:l(t.producedHours)})]}),e.jsxs("div",{className:"flex text-[12px]",children:["矿机生命剩余：",e.jsxs("div",{className:"flex",children:[e.jsxs("div",{children:[360-t.producedHours,"天"]}),S(t.producedHours)!=="1.0"&&e.jsxs("div",{className:"text-[red]",children:["(",S(t.producedHours),"折)"]})]})]})]}),e.jsxs("div",{className:" font-bold text-[12px]",children:[e.jsx(C,{type:H.BALANCE,value:v(t.producedHours),decimalSubLen:2,className:"text-[#895EFF]  mr-1"}),"IDX/台"]})]})})};return e.jsxs("div",{children:[e.jsxs("div",{className:"px-[21px]",children:[e.jsxs("div",{className:"flex pt-4 mb-4",children:[e.jsx(L,{onClick:z,className:"!p-[0] !rounded-2xl",loading:m,children:e.jsx("img",{src:se,alt:""})}),e.jsx("span",{className:"m-auto text-[19px] font-bold",children:"我的订单"})]}),e.jsx("div",{ref:p,style:{height:`${f}px`},className:"no-scrollbar rounded-2xl mb-[4rem] ",children:e.jsx(Y,{height:f,width:"100%",itemCount:n.length,itemSize:80,itemData:n,children:_})})]}),e.jsxs("div",{className:"w-full bg-white h-[64px] flex items-center absolute bottom-0 px-[30px]",children:[e.jsxs("div",{children:[e.jsx("div",{children:"待支付 IDX"}),e.jsx("div",{className:"text-[#FF6D6D] text-[20px] font-bold",children:e.jsx(C,{type:H.BALANCE,value:o,decimalSubLen:2,className:"mr-1.5  font-bold"})})]}),e.jsx(L,{className:"!bg-black !text-white !rounded-3xl !ml-auto   !h-[40px] !w-[100px]",loading:m,onClick:q,disabled:g<o,style:{fontSize:"14px"},children:g>o?"支付":"余额不足"})]})]})};export{ye as default};
