import{u as q,i as F,r as n,l as T,o as I,j as e,D as J,p as W,J as _,s as G,v as K,q as L,V as Y}from"./vendor-CR9QeBO-.js";import{a as Z}from"./arrow-Dt4f_FJz.js";import{f as ee,s as te}from"./helper-CPLEapGt.js";import{c as h}from"../assets/index-Ciym-nWW.js";import{H as R,L as v,C as se}from"./index-URfKUYQd.js";import{A as k,N as E}from"./index-CwKQTuFo.js";import{M}from"./MiningMachineHistory-TCIthN-3.js";import{M as b}from"./MiningMachineSystemLogic-BW-YOQBb.js";const me=()=>{const{address:w}=q(),D=F(),[O,z]=n.useState([]),[re,H]=n.useState(!1),[C,B]=n.useState(0),Q=async()=>{try{const t=await T(h,{address:v,abi:b,functionName:"getIDXAmount",args:[1]});B(Number(W(t)))}catch(t){console.error(t)}};n.useEffect(()=>{Q()},[]);const X=()=>{D("/sale-person")},N=n.useCallback(async()=>{try{H(!0);const r=(await T(h,{address:R,abi:M,functionName:"getSellerOrderIds",args:[w,0,100]})).map(s=>Number(s)),i=r.map(s=>({address:R,abi:M,functionName:"allOrders",args:[s]})),x=(await I(h,{contracts:i})).map(s=>({orderId:Number(s.result[0]),seller:s.result[1],buyer:s.result[2],createTime:String(s.result[3]),status:s.result[4],orderType:s.result[5]})),c=r.map(s=>({address:v,abi:b,functionName:"internalOrders",args:[s]})),l=await I(h,{contracts:c}),g=x.map((s,u)=>({...s,price:Number(l[u].result[2])})),a=r.map(s=>({address:v,abi:b,functionName:"getInternalOrderMachineIds",args:[s]})),j=await I(h,{contracts:a});let f=g.map((s,u)=>{const o=j[u].result.map(m=>Number(m));return{...s,machineIds:o}});z(f.sort((s,u)=>s.status-u.status)),console.log("sale person transfer history detail",f)}catch(t){console.error(t)}finally{H(!1)}},[w]);n.useEffect(()=>{N()},[N]);const[S,P]=n.useState(0),A=n.useRef(null);n.useEffect(()=>{if(!A.current)return;const t=()=>{const d=window.innerHeight-120;P(d)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const U=()=>{const t={};return{get:r=>t[r]||null,set:(r,i)=>(t[r]=i,t[r]),clear:()=>{for(const r in t)delete t[r]},reset:r=>{delete t[r]},has:r=>t[r]!==void 0}},V=n.forwardRef(({index:t,style:r,data:i,onHeightChange:d},x)=>{const c=n.useRef(null),[l,g]=n.useState(0);n.useEffect(()=>{const o=c.current;if(!o)return;const m=()=>{const y=o.getBoundingClientRect().height;y!==l&&(g(y),d(t,y))};m();const p=new ResizeObserver(m);return p.observe(o),()=>p.disconnect()},[t,d,l]);const a=i.items[t],j=o=>o===1?"母矿机":"子矿机",f=()=>{const m=[[()=>a.status===0,()=>"等待对方支付"],[()=>a.status===1,()=>"已支付"],[()=>a.status===2,()=>"已撤回"]].find(p=>p[0]());return m?m[1]():"未知状态"},s=()=>a.status!==0,u=()=>{_.confirm({content:"是否撤回交易",onConfirm:async()=>{try{const o=await G(h,{address:v,abi:b,functionName:"cancelInternalMachineOrder",args:[a.orderId]});await K(h,{hash:o,chainId:se}),N(),L.show({content:"撤回成功",position:"center"})}catch(o){L.show({content:"撤回失败",position:"center"}),console.error(o)}}})};return e.jsxs("div",{ref:c,style:{...r},children:[e.jsx("div",{className:"h-[10px]"}),e.jsx("div",{children:e.jsxs("div",{className:"p-[20px] bg-white rounded-2xl text-[14px] flex flex-col gap-1 relative text-[#777777]",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{children:"交易类型:"}),e.jsx("div",{className:"text-black ",children:j(a.orderType)}),e.jsx("div",{className:` ${s()?"bg-[#6e638b]":"bg-[#ff4949]"} ml-auto text-white px-3 py-0.5 rounded-3xl text-[12px]`,children:f()})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{children:"交易单价:"}),e.jsxs("div",{className:"text-black ",children:[e.jsx(k,{type:E.BALANCE,value:a.price*C/a.machineIds.length,decimalSubLen:2,className:"font-bold mr-1"}),"IDX / 台"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{children:"订单数量:"}),e.jsx("div",{className:"text-black ",children:a.machineIds.length})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{children:"发起时间:"}),e.jsx("div",{className:"text-black ",children:ee(+a.createTime)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{children:"接收方钱包地址:"}),e.jsx("div",{className:"text-black ",children:te(a.buyer,4)})]}),e.jsx(J,{className:"!my-2"}),e.jsxs("div",{className:"flex items-end gap-2 py-1",children:[e.jsx("div",{className:"text-[14px]",children:s()?"支付合计":"待支付合计"}),e.jsx("div",{className:"text-[22px]  flex items-end text-black font-bold",children:e.jsx(k,{type:E.BALANCE,value:a.price*C,decimalSubLen:2})}),e.jsx("div",{children:"IDX"})]}),!s()&&e.jsx("button",{className:"rounded-3xl border border-dashed border-[#e1e1e1] text-[18px] text-center py-2",onClick:u,children:"撤回"})]})})]})}),$=({items:t})=>{const r=n.useRef(null),i=n.useRef(U()).current,d=n.useCallback((c,l)=>{var a;i.get(c)!==l&&(i.set(c,l),(a=r.current)==null||a.resetAfterIndex(c))},[i]),x=n.useCallback(c=>i.get(c),[i]);return e.jsx("div",{ref:A,style:{height:`${S}px`,marginTop:"10px"},className:"no-scrollbar",children:e.jsx(Y,{ref:r,height:S,width:"100%",itemCount:t.length,itemSize:x,itemData:{items:t,heightCache:i},children:c=>e.jsx(V,{...c,onHeightChange:d})})})};return e.jsxs("div",{className:"h-full overflow-hidden px-[21px]",children:[e.jsxs("div",{className:"flex pt-4",children:[e.jsx("img",{src:Z,alt:"",onClick:X}),e.jsx("span",{className:"m-auto text-[17px] ",children:"我发起的交易"})]}),e.jsx($,{items:O}),";"]})};export{me as default};
