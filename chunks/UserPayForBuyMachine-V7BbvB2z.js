import{j as s,B as P,y as le,i as de,n as ue,r as m,K as me,u as he,N as D,l as A,o as x,D as L,F as pe,p as xe,q as B,H as ge,v as fe,z as be}from"./vendor-CR9QeBO-.js";import{a as Ne}from"./arrow-Dt4f_FJz.js";import{c as n}from"../assets/index-UMXjEvK5.js";import{H as N,L as h,A as ye,I as Ie,C as je}from"./index-CS9n0aoQ.js";import{A as E,N as k}from"./index-CwKQTuFo.js";import{o as R}from"./orderStore-CEoCXZ7c.js";import{u as we}from"./usePaymentCheck-Db2ne4VA.js";import{M as y}from"./MiningMachineHistory-D9Ky5lmA.js";import{M as g}from"./MiningMachineSystemLogic-BvMT4rBv.js";import"./helper-CPLEapGt.js";const ve=({onClick:r,isLoading:o,text:i,customClass:a,disabled:l})=>s.jsx(P,{onClick:r,className:le(a,"!bg-black !rounded-3xl !text-white flex justify-center py-2 w-full"),disabled:l,loading:o,children:i}),Ae=r=>r===1?"母矿机":"子矿机",Le=r=>{var f;const o=r+"",i=be.SHA256(o).toString(),a=((f=i.match(/[a-zA-Z]/g))==null?void 0:f.slice(0,4).join(""))||"ABCD",l=i.slice(10,14);return(a+l).toUpperCase()},Fe=()=>{const r=de(),{writeContractAsync:o}=ue(),[i,a]=m.useState(!1),[l,f]=m.useState(""),I=me(),d=I.state,z=I.state.machineIds.map(t=>({id:t,mtype:I.state.orderType})),F=()=>{r("/user/history")},U=async()=>{try{const t=await A(n,{address:h,abi:g,functionName:"getIDXAmount",args:[1]}),p=xe(t);f(p)}catch(t){console.error(t)}};m.useEffect(()=>{U()},[]);const[C,W]=m.useState(0),S=m.useRef(null),{address:u}=he(),{isLoading:X,isBalanceSufficient:_,isAllowanceSufficient:Q}=we(D(String(Math.ceil(d.price*+l))));m.useEffect(()=>{if(!S.current)return;const t=()=>{const O=window.innerHeight-370;W(O)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const q=m.useCallback(async()=>{try{const p=(await A(n,{address:N,abi:y,functionName:"getBuyerOrderIds",args:[u,0,100]})).map(e=>Number(e)),T=p.map(e=>({address:N,abi:y,functionName:"allOrders",args:[e]})),K=(await x(n,{contracts:T})).map(e=>({orderId:Number(e.result[0]),seller:e.result[1],buyer:e.result[2],createTime:String(e.result[3]),status:e.result[4],orderType:e.result[5]})),Z=p.map(e=>({address:h,abi:g,functionName:"internalOrders",args:[e]})),$=await x(n,{contracts:Z}),G=K.map((e,c)=>({...e,price:Number($[c].result[2])})),V=p.map(e=>({address:h,abi:g,functionName:"getInternalOrderMachineIds",args:[e]})),Y=await x(n,{contracts:V}),H=G.map((e,c)=>{const w=Y[c].result.map(v=>Number(v));return{...e,machineIds:w}});console.log("buyer list",H);const j=(await A(n,{address:N,abi:y,functionName:"getSellerOrderIds",args:[u,0,100]})).map(e=>Number(e)),ee=j.map(e=>({address:N,abi:y,functionName:"allOrders",args:[e]})),se=(await x(n,{contracts:ee})).map(e=>({orderId:Number(e.result[0]),seller:e.result[1],buyer:e.result[2],createTime:String(e.result[3]),status:e.result[4],orderType:2})),te=j.map(e=>({address:h,abi:g,functionName:"internalOrders",args:[e]})),re=await x(n,{contracts:te}),ae=se.map((e,c)=>({...e,price:Number(re[c].result[2])})),ne=j.map(e=>({address:h,abi:g,functionName:"getInternalOrderMachineIds",args:[e]})),ie=await x(n,{contracts:ne}),M=ae.map((e,c)=>{const w=ie[c].result.map(v=>Number(v));return{...e,machineIds:w}});console.log("seller list",M);let b=[...H,...M];const ce=R.getallListedOrders().map(e=>({...e,orderType:3}));b=b.filter(e=>e.machineIds.length!==0&&(e.seller===u||e.buyer===u)).concat(ce).sort((e,c)=>e.status-c.status);const oe=b.filter(e=>e.status===0&&(e.seller===u||e.buyer===u)).length;R.updateData(b,oe)}catch(t){console.error(t)}},[u]),J=async()=>{try{if(X)return;if(!_){B.show({content:"余额不足",position:"center"});return}a(!0),Q||await o({address:Ie,abi:ge,functionName:"approve",args:[h,D(ye)]});const t=await o({address:h,abi:g,functionName:"buyMachine",args:[d.orderId]});await fe(n,{hash:t,chainId:je}),a(!1),q(),r("/user")}catch(t){B.show({content:"支付失败",position:"center",duration:2e3}),a(!1),console.error(t)}};return s.jsxs("div",{children:[s.jsxs("div",{className:"h-full overflow-hidden px-[21px]",children:[s.jsxs("div",{className:"flex pt-4",children:[s.jsx(P,{onClick:F,className:"!p-[0] !rounded-2xl",loading:i,children:s.jsx("img",{src:Ne,alt:""})}),s.jsx("span",{className:"m-auto text-[17px] font-bold",children:"支付转让矿机费用"})]}),s.jsxs("div",{className:"transfer-container mt-4",children:[s.jsx("div",{className:"text-[16px] font-bold mb-4 text-black",children:"待转让详情"}),s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("div",{className:"flex gap-2",children:["单价:",s.jsx("span",{className:"font-bold text-black",children:s.jsx(E,{type:k.BALANCE,value:d.price*+l/d.machineIds.length,decimalSubLen:2,className:"font-bold"})}),"IDX/台"]}),s.jsxs("div",{className:"",children:["共计：",s.jsx("span",{className:"mr-2 text-[18px] font-bold text-black",children:d.machineIds.length}),"台"]})]}),s.jsx(L,{className:"!mt-[10px] !mb-[0]"}),s.jsxs("div",{className:"flex justify-between py-2 text-[#777777]",children:[s.jsx("div",{children:"#"}),s.jsx("div",{children:"矿机编号"}),s.jsx("div",{children:"矿机类型"})]}),s.jsx(L,{className:"!mt-[10px] !mb-[0]"}),s.jsx("div",{ref:S,style:{height:`${C}px`},className:"no-scrollbar",children:s.jsx(pe,{height:C,width:"100%",itemCount:d.machineIds.length,itemSize:50,itemData:z,children:Ce})})]})]}),s.jsxs("div",{className:"w-full bg-white h-[87px] flex items-center absolute bottom-0 px-[30px]",children:[s.jsxs("div",{children:[s.jsx("div",{children:"待支付 IDX"}),s.jsx("div",{className:"text-[#FF6D6D] text-[22px] font-bold",children:s.jsx(E,{type:k.BALANCE,value:d.price*+l,decimalSubLen:2,className:"mr-1.5  font-bold"})})]}),s.jsx(ve,{customClass:"bg-black text-white rounded-3xl !ml-auto px-8 text-[18px] !h-[50px] !w-[100px]",text:"支付",isLoading:i,onClick:J})]})]})},Ce=({index:r,style:o,data:i})=>{const a=i[r];return s.jsxs("div",{style:{...o,height:"50px"},children:[s.jsxs("div",{className:"flex justify-between py-2",children:[s.jsx("div",{children:r+1}),s.jsxs("div",{children:["#",Le(a.id)]}),s.jsx("div",{children:Ae(a.mtype)})]}),s.jsx(L,{className:"!my-[0]"})]})};export{Fe as default};
